<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ベジタリアン対応レストラン検索</title>
  <!-- CSP を緩和：Google Maps + Google Fonts を許可 -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src  'self' https://maps.googleapis.com;
          script-src   'self' https://maps.googleapis.com 'unsafe-inline';
          style-src    'self' 'unsafe-inline' https://fonts.googleapis.com;
          font-src     'self' data: https://fonts.gstatic.com;
          img-src      'self' data: https://maps.googleapis.com https://maps.gstatic.com;
          connect-src  'self' https://maps.googleapis.com;
        ">
  <style>
    body { font-family: sans-serif; margin:0; padding:1rem; }
    #map { width: 100%; height: 400px; margin-bottom:1rem; }
    #results { list-style:none; padding:0; }
    #results li { margin:4px 0; }
    #controls { margin-bottom:1rem; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="location-input" type="text" placeholder="場所を入力" />
    <button id="search-btn">検索</button>
  </div>
  <div id="map"></div>
  <ul id="results"></ul>

  <script>
    let map, service, autocomplete;
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681236, lng: 139.767125 },
        zoom: 14
      });
      service = new google.maps.places.PlacesService(map);
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("location-input")
      );
      autocomplete.bindTo("bounds", map);

      document.getElementById("search-btn").addEventListener("click", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("候補から場所を選択してください");
          return;
        }
        map.setCenter(place.geometry.location);
        map.setZoom(15);
        searchNearby(place.geometry.location);
      });
    }

  function searchNearby(location) {
  const request = {
    location,
    radius: 1500,
    type: 'restaurant',
    keyword: 'vegetarian'
  };
  console.log('NearbySearch request=', request);
  service.nearbySearch(request, drawResults);
}


function drawResults(places, status) {
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';

  if (status !== google.maps.places.PlacesServiceStatus.OK) {
    console.warn('検索失敗:', status);
    return;
  }

  places.forEach(p => {
    // ★ レストラン以外は除外
    if (!p.types || !p.types.includes('restaurant')) return;

    // ★ 詳細取得して servesVegetarianFood をチェック
    service.getDetails({
      placeId: p.place_id,
      fields: [
        'name',
        'vicinity',
        'geometry',
        'place_id',
        'serves_vegetarian_food'
      ]
    }, (detail, ds) => {
      // ① ここで detail オブジェクトを丸ごと出力
      console.log('getDetails response:', detail, 'status:', ds);
      if (ds === google.maps.places.PlacesServiceStatus.OK
          && detail.servesVegetarianFood) {
        // マーカー設置
        new google.maps.Marker({
          map,
          position: detail.geometry.location
        });

        // place_id から Google マップ URL を生成
        const mapsUrl =
          `https://www.google.com/maps/place/?q=place_id:${detail.place_id}`;

        // リスト要素を作成
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href       = mapsUrl;
        a.textContent= detail.name;
        a.target     = '_blank';
        a.rel        = 'noopener';
        li.appendChild(a);
        li.appendChild(
          document.createTextNode(` — ${detail.vicinity}`)
        );

        resultsEl.appendChild(li);
      }
    });
  });
}

  </script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqBaGedqbzQ5ad-6_0-_JNKy2BDILsqGA&libraries=places&callback=initMap"> </script>
</body>
</html>
