<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ベジタリアン対応レストラン検索</title>
  <!-- CSP を緩和：Google Maps + Google Fonts を許可 -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src  'self' https://maps.googleapis.com;
          script-src   'self' https://maps.googleapis.com 'unsafe-inline';
          style-src    'self' 'unsafe-inline' https://fonts.googleapis.com;
          font-src     'self' data: https://fonts.gstatic.com;
          img-src      'self' data: https://maps.googleapis.com https://maps.gstatic.com;
          connect-src  'self' https://maps.googleapis.com;
        ">
  <style>
    body { font-family: sans-serif; margin:0; padding:1rem; }
    #map { width: 100%; height: 400px; margin-bottom:1rem; }
    #results { list-style:none; padding:0; }
    #results li { margin:4px 0; }
    #controls { margin-bottom:1rem; }
  </style>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="controls">
    <input id="location-input" type="text" placeholder="場所を入力" />
    <button id="search-btn">検索</button>
  </div>
  <div id="map"></div>
  <ul id="results"></ul>

  <script>
      let map, service, autocomplete, distanceService, originLocation;
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681236, lng: 139.767125 },
        zoom: 14
      });
      service = new google.maps.places.PlacesService(map);
      // DistanceMatrixService を初期化
      distanceService = new google.maps.DistanceMatrixService();
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("location-input")
      );
      autocomplete.bindTo("bounds", map);

      document.getElementById("search-btn").addEventListener("click", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("候補から場所を選択してください");
          return;
        }
        // originLocation に検索地点を保存
        originLocation = place.geometry.location;
        map.setCenter(place.geometry.location);
        map.setZoom(15);
        searchNearby(place.geometry.location);
      });
    }

    function searchNearby(location) {
    const request = {
      location,
      radius: 1500,
      type: 'restaurant',
      keyword: 'vegetarian'
    };
    console.log('NearbySearch request=', request);
    service.nearbySearch(request, drawResults);
  }

  function drawResults(places, status) {
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';

  if (status !== google.maps.places.PlacesServiceStatus.OK) {
    console.warn('検索失敗:', status);
    return;
  }

  // 1. レストランのみ抽出
  const restaurants = places.filter(p =>
    p.types && p.types.includes('restaurant')
  );

  // 2. getDetails を Promise 化して並列取得
  const detailPromises = restaurants.map(p => new Promise(resolve => {
    service.getDetails({
      placeId: p.place_id,
      fields: [
        'name',
        'vicinity',
        'geometry',
        'place_id',
        'serves_vegetarian_food'
      ]
    }, (detail, ds) => {
      if (
        ds === google.maps.places.PlacesServiceStatus.OK &&
        detail.geometry &&
        detail.geometry.location
      ) {
        resolve(detail);
      } else {
        // 取得エラーの場合は null を返す
        resolve(null);
      }
    });
  }));

  Promise.all(detailPromises).then(detailsRaw => {
    // 3. null を除去
    const details = detailsRaw.filter(d => d !== null);

    if (!details.length) {
      resultsEl.textContent = '該当する店舗が見つかりませんでした。';
      return;
    }

    // 4. Distance Matrix で徒歩時間取得
    const destinations = details.map(d => d.geometry.location);
    distanceService.getDistanceMatrix({
      origins:      [originLocation],
      destinations: destinations,
      travelMode:   google.maps.TravelMode.WALKING,
      unitSystem:   google.maps.UnitSystem.METRIC,
    }, (dmRes, dmStatus) => {
      if (dmStatus !== 'OK' || !dmRes.rows.length) {
        console.warn('距離取得失敗:', dmStatus);
      }

      // 距離情報をマッピング
      const elements = dmRes.rows[0]?.elements || [];
      const enriched = details.map((d, i) => {
        const el = elements[i] || {};
        return {
          detail:        d,
          distanceText:  el.distance?.text  || '―',
          durationText:  el.duration?.text  || '―',
          durationValue: el.duration?.value || Infinity
        };
      });

      // 5. 徒歩時間順にソート
      enriched.sort((a, b) => a.durationValue - b.durationValue);

      // 6. マーカー＆リスト描画
      enriched.forEach(item => {
        const d = item.detail;

        // マーカー
        new google.maps.Marker({
          map,
          position: d.geometry.location
        });

        // リスト要素
        const li = document.createElement('li');
        // ★カード風デザイン用クラスを追加
        li.classList.add('result-item');

        const a  = document.createElement('a');
        a.href        = `https://www.google.com/maps/place/?q=place_id:${d.place_id}`;
        a.textContent = d.name;
        a.target      = '_blank';
        a.rel         = 'noopener';
        li.appendChild(a);

        // 「要確認」フラグ
        const hasFlag = d.hasOwnProperty('servesVegetarianFood');
        let suffix = ` — ${d.vicinity}`;
        if (!hasFlag) suffix += ' ！ベジタリアンメニューがあるか要確認';

        // 徒歩距離・時間を追加
        suffix += `（徒歩 ${item.distanceText}、約${item.durationText}）`;
        li.appendChild(document.createTextNode(suffix));

        resultsEl.appendChild(li);
      });
    });
  });
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqBaGedqbzQ5ad-6_0-_JNKy2BDILsqGA&libraries=places&callback=initMap"> </script>
</body>
</html>
