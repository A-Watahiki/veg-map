<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 
    'self' 'unsafe-inline' 'unsafe-eval'
    https://maps.googleapis.com
    https://maps.gstatic.com
    https://www.gstatic.com
    https://apis.google.com
    https://accounts.google.com;
  connect-src
    'self'
    https://maps.googleapis.com
    https://maps.gstatic.com
    https://asia-northeast1-blissful-shore-458002-e9.cloudfunctions.net
    https://identitytoolkit.googleapis.com
    https://securetoken.googleapis.com
    https://accounts.google.com
    https://www.googleapis.com
    https://firestore.googleapis.com
    wss://firestore.googleapis.com;
  img-src 
    'self' 
    data: 
    https://maps.googleapis.com 
    https://maps.gstatic.com 
    https://maps.google.com 
    https://www.google.com;
  style-src 
    'self' 'unsafe-inline' 
    https://fonts.googleapis.com 
    https://maps.gstatic.com;
  font-src 
    'self' data: 
    https://fonts.gstatic.com;
  frame-src 
    'self' 
    https://accounts.google.com 
    https://*.firebaseapp.com 
    https://apis.google.com;
">



  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>


  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDa-5ULVWt44aHOKFui6y4bn-tKCJk4xQY",
      authDomain: "blissful-shore-458002-e9.firebaseapp.com",
      projectId: "blissful-shore-458002-e9",
      storageBucket: "blissful-shore-458002-e9.firebasestorage.app",
      messagingSenderId: "570582104108",
      appId: "1:570582104108:web:87c3efeadafc22da9f3989",
      measurementId: "G-TLC59XH1R5"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>

  <link rel="stylesheet" href="styles.css">
</head>
<script>
  // Firebase SDK 読み込み＆initializeAppの後で
  const auth = firebase.auth();
  const db   = firebase.firestore();
</script>
<body>
  <h2>目的地近辺のベジタリアン料理のお店</h2>

<!-- ここから認証フォーム -->
<div id="auth-forms">
  <!-- サインアップ／選択メソッド -->
  <div id="signup-methods">
    <!-- フォームを開くだけのボタンなので id を別に -->
    <button id="btn-email-show">メールで登録</button>
    <button id="btn-google-signin">Google で続行</button>
  </div>

  <!-- メール登録フォーム（最初は非表示） -->
  <div id="signup-form" style="display:none; margin-top:1rem;">
    <h3>メールで新規登録</h3>
    <input id="signup-email"    type="email"    placeholder="メールアドレス" />
    <input id="signup-password" type="password" placeholder="パスワード（6文字以上）" />
    <!-- こちらが本当の「登録する」ボタン -->
    <button id="btn-email-signup">登録する</button>
    <p><a href="#" id="link-to-login">既にアカウントをお持ちの方はこちら</a></p>
  </div>

  <!-- ログインフォーム -->
  <div id="login-form" style="display:none">
    <h3>ログイン</h3>
    <input id="login-email"    type="email"    placeholder="メールアドレス" />
    <input id="login-password" type="password" placeholder="パスワード" />
    <button id="btn-login">ログイン</button>
  </div>
</div>
<!-- ここまで認証フォーム -->
<!-- ユーザー名照合フォーム（ログイン後に表示） -->
<div id="username-verification" style="display:none; margin:1rem 0;">
  <h3>ユーザー名の確認</h3>
  <p>ご所属の名簿に掲載されている「ユーザー名」を入力してください。</p>
  <input id="username-input" type="text" placeholder="ユーザー名を入力" />
  <button id="btn-verify-username">確認</button>
  <p id="username-error" style="color:red; display:none;">ユーザー名が名簿と一致しません。</p>
</div>


  <div id="controls" style="display: none;">
    <input id="location-input" type="text" placeholder="目的地を入力してください" />
    <button id="search-btn">検索</button>
  </div>
  <p class="note">
    ※ 「❗️」マークは「ベジタリアン」「ヴィーガン」などの検索結果に出るものの  
    ビジネスプロフィールに「ベジタリアン料理があるお店」の表記がないお店。  
    ベジタリアンメニューがあるかどうかはとりわけ要確認。
  </p>
  <div class="map-container">
    <div id="map"></div>
    <ul id="results"></ul>
  </div>
  <script>
      let map, service, autocomplete, distanceService, originLocation, originMarker;

      function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681236, lng: 139.767125 },
        zoom: 14
      });
      service = new google.maps.places.PlacesService(map);
      // DistanceMatrixService を初期化
      distanceService = new google.maps.DistanceMatrixService();
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("location-input")
      );
      autocomplete.bindTo("bounds", map);

      document.getElementById("search-btn").addEventListener("click", async () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("候補から場所を選択してください");
          return;
        }
        // originLocation に検索地点を保存
        originLocation = place.geometry.location;
        map.setCenter(place.geometry.location);
        map.setZoom(15);

        // ここで async 関数を呼び出す
        await multiKeywordSearch(originLocation, [
          'vegetarian','vegan',
          'ヴィーガン','ベジタリアン',
          '素食','マクロビ','マクロビオティック']);
      });
    }
// ① async 化
async function multiKeywordSearch(location, keywords) {
  // 1) ID トークンを取得
  const idToken = await auth.currentUser.getIdToken();

  // 2) Cloud Function（searchPlaces）を呼び出し
  const res = await fetch(
    'https://asia-northeast1-blissful-shore-458002-e9.cloudfunctions.net/searchPlaces',
    {
      method: 'POST',
      headers: {
        'Content-Type':  'application/json',
        'Authorization': `Bearer ${idToken}`,
      },
      body: JSON.stringify({
        location: { lat: location.lat(), lng: location.lng() },
        keywords
      })
    }
  );

  if (res.status === 401) {
    alert('検索するにはログインが必要です');
    return;
  }
  if (!res.ok) {
    console.error('検索エラー:', await res.text());
    return;
  }

  // 3) レスポンスをパースして地図＆リストに描画
  const { places } = await res.json();
  drawResults(places, google.maps.places.PlacesServiceStatus.OK);
}


 const PROXY_URL =
    'https://asia-northeast1-blissful-shore-458002-e9.cloudfunctions.net/getVegetarianFlag';

  // メモリ上キャッシュ用オブジェクト
  const vegetarianFlagCache = {};

  /**
   * place_id を渡すと Cloud Function 経由で
   * serves_vegetarian_food フラグを返す
   */
  async function fetchVegetarianFlag(placeId) {
   // 1) まずメモリキャッシュをチェック
   if (vegetarianFlagCache[placeId] !== undefined) {
     return vegetarianFlagCache[placeId];
   }
   // 2) localStorage キャッシュをチェック
   const storageKey = `vegFlag_${placeId}`;
   const stored = localStorage.getItem(storageKey);
  if (stored !== null && stored !== 'undefined') {
    try {
      const flag = JSON.parse(stored);
      vegetarianFlagCache[placeId] = flag;
      return flag;
    } catch (e) {
      // 万が一 parse に失敗したらキャッシュクリアしてフェッチにフォールバック
      localStorage.removeItem(storageKey);
    }
  }

    try {
      const res = await fetch(
        `${PROXY_URL}?place_id=${encodeURIComponent(placeId)}`
      );
      if (!res.ok) {
        console.error('Proxy error:', await res.text());
        return undefined;
      }
      const json = await res.json();
      const flag = json.serves_vegetarian_food;
      if (typeof flag === 'boolean') {
        // boolean のときだけ localStorage に保存
        localStorage.setItem(storageKey, JSON.stringify(flag));
      }
      // 3) フェッチ結果をキャッシュに保存
      vegetarianFlagCache[placeId] = flag;
      localStorage.setItem(storageKey, JSON.stringify(flag));
      return flag;
    } catch (e) {
      console.error('Network error fetching vegetarian flag', e);
      return undefined;
    }
  }

function drawResults(places, status) {
  console.log('drawResults called with', places, status);
  // ■ フィルタ前の検索結果を全件ログに出力
  console.table(places.map(p => ({
    name:     p.name,
    types:    p.types
  })));
  if (status !== google.maps.places.PlacesServiceStatus.OK) {
    console.warn('検索失敗:', status);
    return;
  }

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';


  // 1) 直線距離フィルタ＋レストランフィルタ
  const filtered = places.filter(p => {
    if (!p.types?.includes('restaurant')) return false;
    const dist = google.maps.geometry.spherical.computeDistanceBetween(
      originLocation,
      p.geometry.location
    );
    return dist <= 1500;
  });

    
  // 2. getDetails を Promise 化して並列取得
  const detailPromises = filtered.map(p => new Promise(resolve => {
    service.getDetails({
      placeId: p.place_id,
      // ベジタリアンフラグは REST 経由で取得するため、
      // ここでは Maps JS API がサポートするフィールドのみ指定
      fields: [
        'name',
        'vicinity',
        'geometry',
        'place_id'
      ]
    }, async (detail, ds) => {
      if (
        ds === google.maps.places.PlacesServiceStatus.OK &&
        detail.geometry &&
        detail.geometry.location
      ) {
        try {
          // Cloud Function 経由でベジタリアンフラグを取得
          const flag = await fetchVegetarianFlag(detail.place_id);
          // detail にプロパティとして追加
          detail.servesVegetarianFood = flag;
        } catch (e) {
          console.error('Flag fetch error', e);
          detail.servesVegetarianFood = undefined;
        }
        resolve(detail);
      } else {
        resolve(null);
      }
    });
  }));

  Promise.all(detailPromises).then(detailsRaw => {
    console.log('▶︎ detailPromises resolved, items:', detailsRaw.length);

    // 3. null を除去

    const details = detailsRaw.filter(d => d !== null);

    if (!details.length) {
      resultsEl.textContent = '該当する店舗が見つかりませんでした。';
      return;
    }

    // 4. Distance Matrix で徒歩時間取得
    const destinations = details.map(d => d.geometry.location);
    const CHUNK_SIZE   = 20;  // ← 1チャンクあたりの件数。25 以下かつ origins×destinations≤100 を意識

    // チャンクに分割するヘルパー
    function chunkArray(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i+size));
      }
      return chunks;
    }


  (async () => {
  // 1) まずチャンク化
  const destChunks = chunkArray(destinations, CHUNK_SIZE);
  // 2) 各チャンクごとに Distance Matrix を await で回す
  const matrixResults = [];
  for (const chunk of destChunks) {
    // eslint-disable-next-line no-await-in-loop
    const dmRes = await new Promise(resolve => {
      distanceService.getDistanceMatrix({
        origins:      [ originLocation ],
        destinations: chunk,
        travelMode:   google.maps.TravelMode.WALKING,
        unitSystem:   google.maps.UnitSystem.METRIC
      }, (res, status) => resolve({ res, status }));
    });
    if (dmRes.status !== google.maps.DistanceMatrixStatus.OK) {
      console.warn('DistanceMatrix failed for chunk:', dmRes.status);
      // 必要なら break してフォールバック描画へ
      break;
    }
    matrixResults.push(...dmRes.res.rows[0].elements);
  }

  // 3) matrixResults は元の順序で element オブジェクトが並ぶので、
  //    details[i] と結びつけて enriched 配列を作る
  const enriched = details.map((d, i) => {
    const el = matrixResults[i] || {};
    return {
      detail:        d,
      distanceText:  el.distance?.text  || '―',
      durationText:  el.duration?.text  || '―',
      durationValue: el.duration?.value || Infinity
    };
  }).sort((a, b) => a.durationValue - b.durationValue);

  // 6. マーカー＆リスト描画（徒歩時間順）
  enriched.forEach(item => {
    console.log('Appending list item for', item.detail.name);
    const d = item.detail;
    const needsConfirm = !d.hasOwnProperty('servesVegetarianFood') || d.servesVegetarianFood === false;

  
    // アイコン定義
    const defaultIcon = {
      url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      scaledSize: new google.maps.Size(32, 32)
    };
    const hoverIcon = {
      url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      scaledSize: new google.maps.Size(48, 48)
    };



    // 店名・住所・距離を描画する前に
    const marker = new google.maps.Marker({
      position: d.geometry.location,
      map,
      icon: defaultIcon
    }); 

    const mapsUrl = `https://www.google.com/maps/search/?` + 
    new URLSearchParams({
       api:             '1',
       query:           d.name,          // e.g. "Morricone caffè italiano"
       query_place_id:  d.place_id
     }).toString();

    // 1) <li> は既に flex container
    const li = document.createElement('li');
    li.classList.add('result-item');
    li.style.cursor = 'pointer';
    li.addEventListener('click', () => {
      window.open(mapsUrl, '_blank');
    });

    // マーカー上での hover → マーカー拡大 ＆ li にクラス付与
    marker.addListener('mouseover', () => {
      marker.setIcon(hoverIcon);
      li.classList.add('hover');
    });
    marker.addListener('mouseout', () => {
      marker.setIcon(defaultIcon);
      li.classList.remove('hover');
    });

    // すでにある、li 上での hover → マーカー拡大処理
    li.addEventListener('mouseover', () => marker.setIcon(hoverIcon));
    li.addEventListener('mouseout',  () => marker.setIcon(defaultIcon));

    // 2) 店名カラム
    const nameDiv = document.createElement('div');
    nameDiv.classList.add('item-name');

    // → 要確認フラグが立っていれば先頭に赤いビックリを追加
    if (needsConfirm) {
      const emoji = document.createElement('span');
      emoji.textContent = '❗️ ';
      // optional: emoji.style.color = 'red';
      nameDiv.appendChild(emoji);
    }

    const a = document.createElement('a');
    a.textContent = d.name;
    a.href        = mapsUrl;
    a.target      = '_blank';
    a.rel         = 'noopener';
    a.style.textDecoration = 'none';
    a.style.color = 'inherit';
    nameDiv.appendChild(a);

    // 3) 住所カラム
    const vicinityDiv = document.createElement('div');
    vicinityDiv.classList.add('item-vicinity');
    vicinityDiv.textContent = d.vicinity;

    // 4) 距離＆時間カラム
    const distDiv = document.createElement('div');
    distDiv.classList.add('item-distance');
    distDiv.textContent = `目的地からの距離 ${item.distanceText}、約${item.durationText}`;

    // 5) li に append
    li.append(nameDiv, vicinityDiv, distDiv);
    resultsEl.appendChild(li);
    console.log('▶︎ finished appending', resultsEl.children.length, 'items');
    });
    })();
  });
}

</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ① メール登録フォームを開く
  document.getElementById('btn-email-show')
    .addEventListener('click', () => {
      document.getElementById('signup-methods').style.display = 'none';
      document.getElementById('signup-form').style.display    = 'block';
    });

  // ② 実際にアカウントを作成
  document.getElementById('btn-email-signup')
    .addEventListener('click', async () => {
      console.log('メール登録ボタン押下');
      const email = document.getElementById('signup-email').value;
      const pwd   = document.getElementById('signup-password').value;
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pwd);
        await cred.user.sendEmailVerification();
        alert('登録完了! 確認メールを送信しました。');
      } catch (e) {
        alert('登録エラー: ' + e.message);
      }
    });

  // ③ Google 認証ハンドラ
  document.getElementById('btn-google-signin')
  .addEventListener('click', async () => {
    console.log('Google登録ボタン押下');
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      alert(`${result.user.displayName}さん、ようこそ！`);
    } catch (e) {
      // ユーザーがポップアップを閉じた場合は無視
      if (e.code === 'auth/popup-closed-by-user') {
        console.log('ユーザーによりポップアップが閉じられました');
        return;
      }
      console.error(e);
      alert('Google認証エラー: ' + e.message);
    }
  });


  // 既存の onAuthStateChanged を拡張
  auth.onAuthStateChanged(user => {
    if (!user) {
      // 未ログイン：認証UIだけ
      document.getElementById('auth-forms').style.display          = 'block';
      document.getElementById('username-verification').style.display = 'none';
      document.getElementById('controls').style.display            = 'none';
    } else {
      // ログイン済み：まずユーザー名照合フォームを表示
      document.getElementById('auth-forms').style.display          = 'none';
      document.getElementById('username-verification').style.display = 'block';
      document.getElementById('controls').style.display            = 'none';
    }
  });

  // ユーザー名の照合ボタン
  document.getElementById('btn-verify-username')
    .addEventListener('click', async () => {
      const inputName = document.getElementById('username-input').value.trim();
      const errorEl   = document.getElementById('username-error');

      if (!inputName) {
        errorEl.textContent = 'ユーザー名を入力してください。';
        errorEl.style.display = 'block';
        return;
      }

      try {
        // Firestore に “allowedUsers” コレクションを作っておき、
        // ドキュメントIDを許可するユーザー名として管理しておく想定
        const doc = await db.collection('allowedUsers').doc(inputName).get();
        // ここで取得結果を出力
        if (doc.exists) {
          console.log('allowedUsers のドキュメント:', doc.data());
        } else {
          console.log('allowedUsers に該当ドキュメントがありません:', inputName);
        }

        if (!doc.exists) {
          // 名簿にない場合
          errorEl.textContent = 'ユーザー名が名簿と一致しません。';
          errorEl.style.display = 'block';
          return;
        }

        // 照合OK
        errorEl.style.display = 'none';
        // 必要なら Firestore にマッピング保存
        await db.collection('users').doc(auth.currentUser.uid).set({
          username: inputName,
          verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 検索UIを表示
        document.getElementById('username-verification').style.display = 'none';
        document.getElementById('controls').style.display              = 'flex';
      } catch (e) {
        console.error(e);
        errorEl.textContent = '通信エラーが発生しました。';
        errorEl.style.display = 'block';
      }
    });

  // ④ ログインフォームの開閉＆ログイン実行
  // 「既にアカウントをお持ちの方はこちら」リンク
  document.getElementById('link-to-login')
    .addEventListener('click', e => {
      e.preventDefault();
      document.getElementById('signup-methods').style.display = 'none';
      document.getElementById('signup-form').style.display    = 'none';
      document.getElementById('login-form').style.display     = 'block';
    });

  // ログインボタン
  document.getElementById('btn-login')
    .addEventListener('click', async () => {
      console.log('ログインボタン押下');
      const email = document.getElementById('login-email').value;
      const pwd   = document.getElementById('login-password').value;
      try {
        await auth.signInWithEmailAndPassword(email, pwd);
        alert('ログイン成功！');
      } catch (e) {
        alert('ログインエラー: ' + e.message);
      }
    });

});
</script>


<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqBaGedqbzQ5ad-6_0-_JNKy2BDILsqGA&libraries=places,geometry&callback=initMap">
</script>
</body>
</html>
