<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ベジタリアン対応レストラン検索</title>
  <!-- CSP を緩和：Google Maps + Google Fonts を許可 -->
  <meta http-equiv="Content-Security-Policy"
  content="
    default-src        'self';
    script-src         'self' 'unsafe-inline' 'unsafe-eval'
                       https://maps.googleapis.com
                       https://maps.gstatic.com;
    style-src          'self' 'unsafe-inline'
                       https://fonts.googleapis.com
                       https://maps.gstatic.com;
    img-src            'self' data:
                       https://maps.googleapis.com
                       https://maps.gstatic.com;
    connect-src        'self'
                       https://maps.googleapis.com
                       https://maps.gstatic.com
                       https://asia-northeast1-blissful-shore-458002-e9.cloudfunctions.net;
    font-src           'self' data:
                       https://fonts.gstatic.com;
  ">
  <style>
    body { font-family: sans-serif; margin:0; padding:1rem; }
    #map { width: 100%; height: 400px; margin-bottom:1rem; }
    #results { list-style:none; padding:0; }
    #results li { margin:4px 0; }
    #controls { margin-bottom:1rem; }
  </style>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="controls">
    <input id="location-input" type="text" placeholder="場所を入力" />
    <button id="search-btn">検索</button>
  </div>
  <div id="map"></div>
  <ul id="results"></ul>

  <script>
      let map, service, autocomplete, distanceService, originLocation;
      function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.681236, lng: 139.767125 },
        zoom: 14
      });
      service = new google.maps.places.PlacesService(map);
      // DistanceMatrixService を初期化
      distanceService = new google.maps.DistanceMatrixService();
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("location-input")
      );
      autocomplete.bindTo("bounds", map);

      document.getElementById("search-btn").addEventListener("click", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) {
          alert("候補から場所を選択してください");
          return;
        }
        // originLocation に検索地点を保存
        originLocation = place.geometry.location;
        map.setCenter(place.geometry.location);
        map.setZoom(15);
        multiKeywordSearch(place.geometry.location, ['vegetarian','vegan']);
      });
    }

    function multiKeywordSearch(location, keywords) {

    let overLimit = false;
    const allPromises = keywords.map(kw => new Promise(resolve => {
    service.nearbySearch({
      location,
      radius: 1500,
      type: 'restaurant',
      keyword: kw
    }, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
        overLimit = true;
        resolve([]);  // 空配列返して処理だけ続ける
      }
      else if (status === google.maps.places.PlacesServiceStatus.OK) {
        resolve(results);
      }
      else {
        resolve([]);
      }
    });
  }));


   Promise.all(allPromises).then(resultsArray => {
    console.log('multiKeyword results:', resultsArray);
    if (overLimit) {
      // ボタンを無効化して以降の検索をストップ
      const btn = document.getElementById('search-btn');
      btn.disabled = true;
      alert('無料クォータを超過しました。新しい検索はできません。');
      return;
    }
    // 手動で flatten
    const allPlaces = resultsArray.reduce((acc, arr) => acc.concat(arr), []);
    // place_id で重複除去
    const merged = [];
    const seen   = new Set();
    allPlaces.forEach(p => {
      if (!seen.has(p.place_id)) {
        seen.add(p.place_id);
        merged.push(p);
      }
    });
      // 結果を drawResults に渡す（ステータスOK扱い）
      drawResults(merged, google.maps.places.PlacesServiceStatus.OK);
    });
  }

  function sendHeightToParent() {
  const h = document.documentElement.scrollHeight;
  // '*' ではなくあなたの Studio 側ドメインを指定しておくのが望ましいです
  window.parent.postMessage({ type: 'resize', height: h }, '*');
}

 // Cloud Function の URL に置き換えてください
 const PROXY_URL =
    'https://asia-northeast1-blissful-shore-458002-e9.cloudfunctions.net/getVegetarianFlag';

  /**
   * place_id を渡すと Cloud Function 経由で
   * serves_vegetarian_food フラグを返す
   */
  async function fetchVegetarianFlag(placeId) {
    try {
      const res = await fetch(
        `${PROXY_URL}?place_id=${encodeURIComponent(placeId)}`
      );
      if (!res.ok) {
        console.error('Proxy error:', await res.text());
        return undefined;
      }
      const json = await res.json();
      return json.serves_vegetarian_food;  // true/false/undefined
    } catch (e) {
      console.error('Network error fetching vegetarian flag', e);
      return undefined;
    }
  }

function drawResults(places, status) {
  console.log('drawResults called with', places, status);
  if (status !== google.maps.places.PlacesServiceStatus.OK) {
    console.warn('検索失敗:', status);
    return;
  }

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';


  // 1) 直線距離フィルタ＋レストランフィルタ
  const filtered = places.filter(p => {
    if (!p.types?.includes('restaurant')) return false;
    const dist = google.maps.geometry.spherical.computeDistanceBetween(
      originLocation,
      p.geometry.location
    );
    return dist <= 1500;
  });

    
  // 2) マーカー＆簡易リスト描画（forEach のブロック）
  filtered.forEach(p => {
    new google.maps.Marker({
      map,
      position: p.geometry.location
    });
    const li = document.createElement('li');
    const a  = document.createElement('a');
    a.href        = `https://www.google.com/maps/place/?q=place_id:${p.place_id}`;
    a.textContent = p.name;
    a.target      = '_blank';
    a.rel         = 'noopener';
    li.appendChild(a);
    li.appendChild(document.createTextNode(` — ${p.vicinity}`));
    resultsEl.appendChild(li);
  }); 

  // 2. getDetails を Promise 化して並列取得
  const detailPromises = restaurants.map(p => new Promise(resolve => {
    service.getDetails({
      placeId: p.place_id,
      // ベジタリアンフラグは REST 経由で取得するため、
      // ここでは Maps JS API がサポートするフィールドのみ指定
      fields: [
        'name',
        'vicinity',
        'geometry',
        'place_id'
      ]
    }, async (detail, ds) => {
      if (
        ds === google.maps.places.PlacesServiceStatus.OK &&
        detail.geometry &&
        detail.geometry.location
      ) {
        try {
          // Cloud Function 経由でベジタリアンフラグを取得
          const flag = await fetchVegetarianFlag(detail.place_id);
          // detail にプロパティとして追加
          detail.servesVegetarianFood = flag;
        } catch (e) {
          console.error('Flag fetch error', e);
          detail.servesVegetarianFood = undefined;
        }
        resolve(detail);
      } else {
        resolve(null);
      }
    });
  }));

  Promise.all(detailPromises).then(detailsRaw => {
    console.log('▶︎ detailPromises resolved, items:', detailsRaw.length);

    // 3. null を除去

    const details = detailsRaw.filter(d => d !== null);

    if (!details.length) {
      resultsEl.textContent = '該当する店舗が見つかりませんでした。';
      sendHeightToParent();
      return;
    }

    // 4. Distance Matrix で徒歩時間取得
    const destinations = details.map(d => d.geometry.location);
    const CHUNK_SIZE   = 20;  // ← 1チャンクあたりの件数。25 以下かつ origins×destinations≤100 を意識

    // チャンクに分割するヘルパー
    function chunkArray(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i+size));
      }
      return chunks;
    }


  (async () => {
  // 1) まずチャンク化
  const destChunks = chunkArray(destinations, CHUNK_SIZE);
  // 2) 各チャンクごとに Distance Matrix を await で回す
  const matrixResults = [];
  for (const chunk of destChunks) {
    // eslint-disable-next-line no-await-in-loop
    const dmRes = await new Promise(resolve => {
      distanceService.getDistanceMatrix({
        origins:      [ originLocation ],
        destinations: chunk,
        travelMode:   google.maps.TravelMode.WALKING,
        unitSystem:   google.maps.UnitSystem.METRIC
      }, (res, status) => resolve({ res, status }));
    });
    if (dmRes.status !== google.maps.DistanceMatrixStatus.OK) {
      console.warn('DistanceMatrix failed for chunk:', dmRes.status);
      // 必要なら break してフォールバック描画へ
      break;
    }
    matrixResults.push(...dmRes.res.rows[0].elements);
  }

  // 3) matrixResults は元の順序で element オブジェクトが並ぶので、
  //    details[i] と結びつけて enriched 配列を作る
  const enriched = details.map((d, i) => {
    const el = matrixResults[i] || {};
    return {
      detail:        d,
      distanceText:  el.distance?.text  || '―',
      durationText:  el.duration?.text  || '―',
      durationValue: el.duration?.value || Infinity
    };
  }).sort((a, b) => a.durationValue - b.durationValue);

      // 6. マーカー＆リスト描画（徒歩時間順）
      enriched.forEach(item => {
        console.log('Appending list item for', item.detail.name);
        const d = item.detail;
        const mapsUrl = `https://www.google.com/maps/place/?q=place_id:${d.place_id}`;

        // マーカー
        new google.maps.Marker({
          map,
          position: d.geometry.location
        });

        // リスト要素を作成
        const li = document.createElement('li');
        li.classList.add('result-item');
        li.style.cursor = 'pointer';
        // カード全体クリックでリンクを開く
        li.addEventListener('click', () => {
          window.open(mapsUrl, '_blank');
        });

        // 店名
        const a = document.createElement('a');
        a.textContent = d.name;
        a.href        = mapsUrl;
        a.target      = '_blank';
        a.rel         = 'noopener';
        a.style.textDecoration = 'none';
        a.style.color = 'inherit';
        li.appendChild(a);

        // 要確認フラグ
        const hasFlag = d.hasOwnProperty('servesVegetarianFood');
        let metaText = `${d.vicinity}`;
        if (!hasFlag) metaText += ' ！ベジタリアンメニューがあるか要確認';
        // 徒歩距離・時間
        metaText += `（徒歩 ${item.distanceText}、約${item.durationText}）`;

        const meta = document.createElement('div');
        meta.classList.add('meta');
        meta.textContent = metaText;
        li.appendChild(meta);

        resultsEl.appendChild(li);
        console.log('▶︎ finished appending', resultsEl.children.length, 'items');

      });

      // 7. 親ページへ高さを通知
      sendHeightToParent();
    })();
  });
}

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqBaGedqbzQ5ad-6_0-_JNKy2BDILsqGA&libraries=places,geometry&callback=initMap">
</script>
</body>
</html>
